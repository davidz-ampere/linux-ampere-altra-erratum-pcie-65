From 64ecd4272987ca0ca943fd479f6ec2756123adba Mon Sep 17 00:00:00 2001
From: Huang Shijie <shijie@os.amperecomputing.com>
Date: Fri, 8 Apr 2022 20:43:33 +0000
Subject: [PATCH 04/10] arm64: remove the hardcode about PCI address checking

Copy name in find_next_iomem_res() for checking the PCI
address.

Remove the bool check for VM which does not has the ALTRA pci device.

Signed-off-by: Huang Shijie <shijie@os.amperecomputing.com>
---
 arch/arm64/include/asm/pgtable.h |  7 +++---
 include/linux/pci.h              |  4 +++
 kernel/resource.c                | 43 ++++++++++++++++++++++++++++++++
 mm/ioremap.c                     | 12 +++------
 4 files changed, 53 insertions(+), 13 deletions(-)

diff --git a/arch/arm64/include/asm/pgtable.h b/arch/arm64/include/asm/pgtable.h
index e49603e84c1d..f10b3b7ce04c 100644
--- a/arch/arm64/include/asm/pgtable.h
+++ b/arch/arm64/include/asm/pgtable.h
@@ -575,6 +575,8 @@ static inline void set_pud_at(struct mm_struct *mm, unsigned long addr,
 
 #ifdef CONFIG_ALTRA_ERRATUM_82288
 extern bool have_altra_erratum_82288;
+extern bool range_is_pci(phys_addr_t, size_t);
+
 #endif
 
 static inline pte_t pte_mkspecial(pte_t pte)
@@ -583,10 +585,7 @@ static inline pte_t pte_mkspecial(pte_t pte)
 	phys_addr_t phys = __pte_to_phys(pte);
 	pgprot_t prot = __pgprot(pte_val(pte) & ~PTE_ADDR_MASK);
 
-	if (unlikely(have_altra_erratum_82288) &&
-	    (phys < 0x80000000 ||
-	     (phys >= 0x200000000000 && phys < 0x400000000000) ||
-	     (phys >= 0x600000000000 && phys < 0x800000000000))) {
+	if (range_is_pci(phys, PAGE_SIZE)) {
 		pte = __pte(__phys_to_pte_val(phys) | pgprot_val(pgprot_device(prot)));
 	}
 #endif
diff --git a/include/linux/pci.h b/include/linux/pci.h
index 7e8e8633ad90..3f0f657d45b6 100644
--- a/include/linux/pci.h
+++ b/include/linux/pci.h
@@ -2560,4 +2560,8 @@ void pci_ims_free_irq(struct pci_dev *pdev, struct msi_map map);
 	WARN_ONCE(condition, "%s %s: " fmt, \
 		  dev_driver_string(&(pdev)->dev), pci_name(pdev), ##arg)
 
+#ifdef CONFIG_ALTRA_ERRATUM_82288
+extern bool range_is_pci(phys_addr_t phys_addr, size_t size);
+#endif
+
 #endif /* LINUX_PCI_H */
diff --git a/kernel/resource.c b/kernel/resource.c
index b1763b2fd7ef..2e65afe5c137 100644
--- a/kernel/resource.c
+++ b/kernel/resource.c
@@ -364,6 +364,7 @@ static int find_next_iomem_res(resource_size_t start, resource_size_t end,
 			.flags = p->flags,
 			.desc = p->desc,
 			.parent = p->parent,
+			.name = p->name,
 		};
 	}
 
@@ -489,6 +490,48 @@ int __weak page_is_ram(unsigned long pfn)
 }
 EXPORT_SYMBOL_GPL(page_is_ram);
 
+#ifdef CONFIG_ALTRA_ERRATUM_82288
+/* Return 0 on success, else return 1 */
+static int pci_addr_check(struct resource *r, void *p)
+{
+	if (!r->name)
+		return 1;
+
+	if (strlen(r->name) <= 2)
+		return 1;
+
+	if (memcmp(r->name, "PCI", 3))
+		return 1;
+
+	/* Success */
+	return 0;
+}
+
+bool range_is_pci(phys_addr_t phys_addr, size_t size)
+{
+	u64 start, end;
+	int ret;
+
+	start = phys_addr;
+	end = phys_addr + size;
+
+	/* Check the 32bit */
+	ret = walk_iomem_res_desc(IORES_DESC_NONE, IORESOURCE_MEM,
+			start, end, NULL, pci_addr_check);
+	if (!ret)
+		return true;
+
+	/* Check the 64bit */
+	ret = walk_iomem_res_desc(IORES_DESC_NONE, IORESOURCE_MEM_64,
+			start, end, NULL, pci_addr_check);
+	if (!ret)
+		return true;
+
+	return false;
+}
+EXPORT_SYMBOL_GPL(range_is_pci);
+#endif
+
 static int __region_intersects(struct resource *parent, resource_size_t start,
 			       size_t size, unsigned long flags,
 			       unsigned long desc)
diff --git a/mm/ioremap.c b/mm/ioremap.c
index 3f1f742ed836..545c8043b31b 100644
--- a/mm/ioremap.c
+++ b/mm/ioremap.c
@@ -14,14 +14,6 @@
 #ifdef CONFIG_ALTRA_ERRATUM_82288
 bool have_altra_erratum_82288 __read_mostly;
 EXPORT_SYMBOL(have_altra_erratum_82288);
-
-static bool is_altra_pci(phys_addr_t phys_addr, size_t size)
-{
-	phys_addr_t end = phys_addr + size;
-	return (phys_addr < 0x80000000 ||
-		(end > 0x200000000000 && phys_addr < 0x400000000000) ||
-		(end > 0x600000000000 && phys_addr < 0x800000000000));
-}
 #endif
 
 void __iomem *ioremap_prot(phys_addr_t phys_addr, size_t size,
@@ -53,8 +45,10 @@ void __iomem *ioremap_prot(phys_addr_t phys_addr, size_t size,
 	area->phys_addr = phys_addr;
 
 #ifdef CONFIG_ALTRA_ERRATUM_82288
-	if (unlikely(have_altra_erratum_82288 && is_altra_pci(phys_addr, size)))
+	if ((pgprot_val(pgprot) != pgprot_val(pgprot_device(pgprot))) &&
+			range_is_pci(phys_addr, size)) {
 		pgprot = pgprot_device(pgprot);
+	}
 #endif
 
 	if (ioremap_page_range(vaddr, vaddr + size, phys_addr,
-- 
2.39.3

